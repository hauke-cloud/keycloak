apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: {{ include "keycloak.name" . }}
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
spec:
  {{- with .Values.keycloak.hostname }}
  hostname:
  {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.keycloak.ingress }}
  ingress:
  {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.keycloak.image }}
  image: {{ .repository }}:{{ .tag | default .Chart.AppVersion }}
  {{- end }}

  instances: {{ .Values.keycloak.replicaCount | default 1 }}

  {{- with .Values.keycloak.resources }}
  resources:
  {{- toYaml . | nindent 4}}
  {{- end }}

  db:
  {{- if (hasKey .Values.keycloak "db") }}
  {{- toYaml .Values.keycloak.db | nindent 4 }}
  {{- else }}
    database: {{ .Values.database.bootstrap.initdb.database | default "keycloak" }}
    schema: public
    host: {{ include "keycloak.name" . }}-db-rw.{{ .Release.Namespace }}.svc.cluster.local
    port: 5432
    passwordSecret:
      name: {{ include "keycloak.name" . }}-db-app
      key: password
      optional: false
    usernameSecret:
      name: {{ include "keycloak.name" . }}-db-app
      key: username
      optional: false
  {{- end }}

  {{- with .Values.keycloak.http }}
  http:
  {{- toYaml . | nindent 4 }}
  {{- end }}
